#
# Sound Driver (for PlayStation 2) by K.Muraoka
# Copyright (C) Konami Computer Entertainment Japan
# Codebase Restoration by Joy Division
#
# ver."ZONE OF THE ENDERS"
#

ifeq ($(wildcard PathDefs),)
PathDefs:
	iop-path-setup > PathDefs || (rm -f PathDefs ; exit 1)
endif
include PathDefs

SCETOP ?= /usr/local/sce
SCEINCDIR = $(SCETOP)/common/include
IOPINCDIR = $(SCETOP)/iop/gcc/mipsel-scei-elfl/include
IOPLIBDIR = $(SCETOP)/iop/gcc/mipsel-scei-elfl/lib
IOPMODDIR = $(SCETOP)/iop/modules

###############################################################################

INCDIR = ../include
LIBDIR = ../lib

INCDIRS = -I. -I$(INCDIR) -I$(SCEINCDIR)

ILIBS =\
-ilb=libsd.ilb \
-ilb=$(LIBDIR)/jsifman.ilb \
-ilb=$(LIBDIR)/usbfs.ilb \
-ilb=$(LIBDIR)/cdbios.ilb

CFLAGS  = -Wall -G0 $(INCDIRS) -O0
ASFLAGS = $(INCDIRS) -G0
LDLIBS  =

# "CL" variables for custom linker script use:

CLILIBS =\
libsd.ilb \
$(LIBDIR)/jsifman.ilb \
$(LIBDIR)/usbfs.ilb \
$(LIBDIR)/cdbios.ilb \
$(IOPLIBDIR)/iop.ilb

CLLIBS =\
-L$(SCETOP)/iop/gcc/lib/gcc-lib/mipsel-scei-elfl/2.8.1 \
-L$(SCETOP)/iop/gcc/mipsel-scei-elfl/lib

CLSTUB = zoesound_ilb_sub
CLREL = zoesound_iop_rel.o

PROGNAME = iop_main.irx

OBJS =\
	iop_main.o \
	sd_file.o \
	sd_sub1.o \
	sd_sub2.o \
	sd_ioset.o \
	sd_drv.o \
	sd_main.o \
	sd_cli.o \
	sd_mstr.o \
	sd_wk.o \
	sd_str.o \
	sd_str2.o \
	sd_str3.o \
	se_tblmd.o

###############################################################################

all: $(PROGNAME)

clean:
	-rm -f *.o $(PROGNAME)

$(PROGNAME): $(OBJS)
	#~ $(LINK.o) -o $@ $(OBJS) $(ILIBS)
	$(ILBLD) -s $(CLSTUB).s $(CLLIBS) $(OBJS) -lgcc : $(CLILIBS)
	$(AS) $(CLSTUB).s -o $(CLSTUB).o
	$(LD) -EL -dc -r -T ldscript.txt -o $(CLREL) $(CLLIBS) $(OBJS) $(CLSTUB).o -lgcc
	$(IFIXUP) -r $(PROGNAME) $(CLREL)
	rm $(CLREL) $(CLSTUB).{s,o}
